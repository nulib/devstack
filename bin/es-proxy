#!/usr/bin/env ruby

require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'

  gem 'aws-sdk-core'
  gem 'aws-sdk-elasticsearchservice'
end

require 'aws-sdk-core'
require 'aws-sdk-elasticsearchservice'

def main
  ENV['AWS_PROFILE'] ||= ENV['AWS_DEFAULT_PROFILE']
  credentials = shared_credentials()
  endpoint = elasticsearch_endpoint(credentials)
  region = `aws configure get region --profile #{credentials.profile_name}`.chomp
  cmdline = [
    'docker',
    'run',
    '-v',
    "#{ENV['HOME']}/.aws:/.aws",
    '-e',
    "AWS_PROFILE=#{ENV['AWS_PROFILE']}",
    '-e',
    "AWS_REGION=#{region}",
    '-ti',
    '-p',
    '9200:8080',
    'cllunsford/aws-signing-proxy',
    '-target',
    endpoint
  ]
  warn "Proxying http://localhost:9200/ to #{endpoint}"
  warn "Kibana available on http://localhost:9200/_plugin/kibana/"
  Kernel.system(*cmdline, out: File::NULL)
end

def elasticsearch_endpoint(credentials)
  es = Aws::ElasticsearchService::Client.new(credentials: credentials)
  domain_name = es.list_domain_names.domain_names.find { |domain| domain.domain_name =~ /common-index/ }.domain_name
  endpoint = es.describe_elasticsearch_domain(domain_name: domain_name).domain_status.endpoint
  "https://#{endpoint}"
rescue Aws::SSM::Errors::ExpiredTokenException
  aws_session_error(credentials, 'AWS session token for profile %s is expired.')
end

def shared_credentials
  Aws::SharedCredentials.new.tap do |credentials|
    if credentials.credentials.nil?
      aws_session_error(credentials, 'AWS Credentials not found for profile %s.') 
    end
  end
end

def aws_session_error(credentials, error_string)
  profile = credentials.profile_name
  $stderr.puts <<~__EOC__
  #{error_string % profile} Please run the following command and try again:

      aws-adfs login --adfs-host=ads-fed.northwestern.edu --profile=#{profile}
  __EOC__
  exit(128)
end

main()